@model IEnumerable<ABCRetailers.Models.Product>
@{
    // Define Roles for easier access
    var isAdmin = User.IsInRole("Admin");
    var isCustomer = User.IsInRole("Customer");

    ViewData["Title"] = isAdmin ? "Manage Products" : "Our Products";
}

@* --- TEMPDATA FOR SUCCESS/ERROR MESSAGES --- *@
@if (TempData["SuccessMessage"] is string success)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @success
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["ErrorMessage"] is string error)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @error
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}


<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-box"></i> @ViewData["Title"]</h2>

    @* --- ADMIN: Add New Product Button --- *@
    @if (isAdmin)
    {
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add New Product
        </a>
    }
</div>

@if (Model != null && Model.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Image</th>
                    <th>Product Name</th>
                    @* Only show Product ID if Admin is viewing *@
                    @if (isAdmin)
                    {
                        <th>Product ID</th>
                    }
                    <th>Description</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model)
                {
                    // Truncate ID for display
                    var shortId = !string.IsNullOrWhiteSpace(product?.Id)
                    ? (product.Id.Length > 8 ? product.Id[..8] + "…" : product.Id)
                    : "-";
                    var desc = product?.Description ?? "";

                    // Style stock display
                    var stock = product?.StockAvailable ?? 0;
                    var badge = stock > 10 ? "success" : stock > 0 ? "warning" : "danger";

                    <tr>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(product?.ImageUrl))
                            {
                                <img src="@product.ImageUrl" alt="@product.ProductName" class="img-thumbnail" style="width:50px;height:50px;object-fit:cover;">
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            }
                        </td>
                        <td>@product?.ProductName</td>
                        @if (isAdmin)
                        {
                            <td><code>@shortId</code></td>
                        }
                        <td>@(desc.Length > 50 ? desc.Substring(0, 50) + "…" : desc)</td>
                        <td>
                            <strong class="text-success">@product?.Price.ToString("C")</strong>
                            @if ((product?.Price ?? 0m) <= 0m)
                            {
                                <br />
                                <small class="text-danger">⚠️ Price not set</small>
                            }
                        </td>
                        <td>
                            <span class="badge bg-@badge">@stock</span>
                            @if (stock == 0)
                            {
                                <small class="text-danger d-block">Out of Stock</small>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group" role="group">

                                @* --- ACTIONS FOR ADMIN (Edit/Delete) --- *@
                                @if (isAdmin)
                                {
                                    <a asp-action="Edit" asp-route-id="@product?.Id" class="btn btn-sm btn-outline-primary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                            onclick="confirmDelete('@product?.Id','@product?.ProductName')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                }

                                @* --- ACTION FOR CUSTOMER (Add to Cart) --- *@
                                @if (isCustomer && stock > 0)
                                {
                                    <form asp-controller="Cart" asp-action="AddToCart" method="post" style="display:inline;">
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <input type="hidden" name="quantity" value="1" /> @* Default to 1 *@
                                        <button type="submit" class="btn btn-sm btn-success" title="Add to Cart">
                                            <i class="fas fa-cart-plus"></i> Add
                                        </button>
                                    </form>
                                }
                                else if (isCustomer && stock == 0)
                                {
                                    <span class="btn btn-sm btn-outline-secondary disabled" title="Out of Stock">
                                        <i class="fas fa-ban"></i>
                                    </span>
                                }
                                @* If user is neither Admin nor Customer (i.e., not logged in), show no actions. *@
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No products found.
        @if (isAdmin)
        {
            <a asp-action="Create" class="alert-link">Add your first product</a>
            
       }
    </div>
}

@* --- Delete Confirmation Modal (Only needed for Admin) --- *@
@if (isAdmin)
{
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete product <strong id="productName"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
    <script>
        function confirmDelete(productId, productName) {
            document.getElementById('productName').textContent = productName || '';
            // Uses the standard DELETE action on the Product Controller
            document.getElementById('deleteForm').action = '@Url.Action("Delete", "Product")/' + encodeURIComponent(productId || '');
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
    </script>
    }
}